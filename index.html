<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentin & Marilou | Album</title>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff85a1; --bg: #fff5f7; --text: #4a4a4a; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; scroll-behavior: smooth; }
        #lock-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 320px; }
        #main-content { display: none; }
        header { text-align: center; padding: 30px 20px; background: white; border-bottom: 1px solid #ffe0e6; }
        h1 { font-family: 'Dancing Script', cursive; font-size: 2.8rem; color: var(--primary); margin: 0; }
        
        .nav-wrapper { position: sticky; top: 0; background: white; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .anchor-nav { display: flex; gap: 10px; overflow-x: auto; padding: 12px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .anchor-link { background: var(--bg); color: var(--primary); padding: 8px 18px; border-radius: 20px; text-decoration: none; font-size: 0.8rem; font-weight: 600; border: 1px solid #ffe0e6; }
        
        .section-title { font-family: 'Dancing Script', cursive; color: var(--primary); font-size: 2.2rem; margin: 30px 20px 15px 20px; padding-bottom: 5px; border-bottom: 2px solid #ffe0e6; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; padding: 0 20px; }
        .photo-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        
        #upload-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 30px; box-shadow: 0 5px 15px rgba(255,133,161,0.4); z-index: 500; }
        .manage-link { position: fixed; bottom: 30px; left: 20px; background: white; color: var(--primary); padding: 10px 15px; border-radius: 20px; text-decoration: none; font-size: 0.75rem; font-weight: 600; border: 1px solid var(--primary); z-index: 500; }

        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; touch-action: none; }
        #lightbox img { max-width: 100%; max-height: 90%; object-fit: contain; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); color: white; border: none; padding: 25px 15px; font-size: 35px; cursor: pointer; z-index: 10001; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 15px; }
        input { padding: 12px; border: 2px solid #eee; border-radius: 10px; width: 90%; outline: none; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="login-box">
        <h2 style="font-family: 'Dancing Script'; color: var(--primary); font-size: 2.2rem;">Notre Album</h2>
        <input type="password" id="pass-input" placeholder="Mot de passe...">
        <button class="btn" onclick="checkPassword()">Ouvrir</button>
    </div>
</div>

<div id="main-content">
    <header><h1>Valentin & Marilou</h1></header>
    <div class="nav-wrapper"><div class="anchor-nav" id="anchor-nav"></div></div>
    
    <div id="full-gallery"></div>

    <a href="https://console.cloudinary.com/console/c-668573934301548e647900b953d441/media_library/folders/home" target="_blank" class="manage-link">⚙️ Gérer l'album</a>
    <button id="upload-btn" onclick="startUpload()">+</button>
</div>

<div id="lightbox">
    <button style="position:absolute;top:20px;right:20px;color:white;background:none;border:none;font-size:45px;z-index:10002;" onclick="closeLightbox()">×</button>
    <button class="nav-arrow" style="left:0;" onclick="changePhoto(-1); event.stopPropagation();">‹</button>
    <img id="lightbox-img" src="" onclick="event.stopPropagation()">
    <button class="nav-arrow" style="right:0;" onclick="changePhoto(1); event.stopPropagation();">›</button>
</div>

<script>
    const CONFIG = {
        CLOUD_NAME: "ditbsvebr",
        UPLOAD_PRESET: "souvenirs_preset",
        TAG_ROOT: "souvenirs_valentin_marilou",
        PASSWORD: "19.Juin.2025"
    };

    let allPhotos = [];
    let currentIndex = 0;

    if (localStorage.getItem('isLogged') === 'true') unlock();

    function checkPassword() {
        if (document.getElementById('pass-input').value === CONFIG.PASSWORD) {
            localStorage.setItem('isLogged', 'true'); unlock();
        } else alert("Mot de passe incorrect ❤️");
    }

    function unlock() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadPhotos();
    }

    async function loadPhotos() {
        const url = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/list/${CONFIG.TAG_ROOT}.json?v=${new Date().getTime()}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            allPhotos = data.resources;
            
            const grouped = {};
            allPhotos.forEach(img => {
                let event = (img.context?.custom?.caption && img.context.custom.caption !== "[object Object]") ? img.context.custom.caption : "Nos Souvenirs";
                if (!grouped[event]) grouped[event] = [];
                grouped[event].push(img);
            });

            renderNav(grouped);
            renderGallery(grouped);
        } catch (err) { console.error("Erreur de chargement"); }
    }

    function renderNav(grouped) {
        const nav = document.getElementById('anchor-nav');
        nav.innerHTML = Object.keys(grouped).sort().map(e => `<a href="#${e.replace(/\s+/g, '-')}" class="anchor-link">${e}</a>`).join('');
    }

    function renderGallery(grouped) {
        const container = document.getElementById('full-gallery');
        container.innerHTML = Object.keys(grouped).sort().map(event => `
            <div id="${event.replace(/\s+/g, '-')}">
                <div class="section-title">${event}</div>
                <div class="photo-grid">
                    ${grouped[event].map(img => `
                        <img class="photo-item" src="https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/w_400,c_fill,g_auto/${img.public_id}.${img.format}" onclick="openLightbox('${img.public_id}')">
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function openLightbox(pid) {
        currentIndex = allPhotos.findIndex(p => p.public_id === pid);
        updateLightbox();
        document.getElementById('lightbox').style.display = 'flex';
    }

    function updateLightbox() {
        const img = allPhotos[currentIndex];
        document.getElementById('lightbox-img').src = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/q_auto,f_auto/${img.public_id}.${img.format}`;
    }

    function changePhoto(dir) {
        currentIndex = (currentIndex + dir + allPhotos.length) % allPhotos.length;
        updateLightbox();
    }

    function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

    // Swipe Mobile
    let startX = 0;
    const lightbox = document.getElementById('lightbox');
    lightbox.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    lightbox.addEventListener('touchend', e => {
        const endX = e.changedTouches[0].clientX;
        if (startX - endX > 50) changePhoto(1);
        if (endX - startX > 50) changePhoto(-1);
    });

    function startUpload() {
        const name = prompt("Nom de l'événement ?", "Sortie");
        if (!name) return;
        cloudinary.openUploadWidget({
            cloudName: CONFIG.CLOUD_NAME, uploadPreset: CONFIG.UPLOAD_PRESET,
            tags: [CONFIG.TAG_ROOT], context: { caption: name.trim() },
            sources: ['local', 'camera'], multiple: true, 
            clientAllowedFormats: ["png","jpg","jpeg","heic"],
            language: "fr"
        }, (error, result) => { if (!error && result.event === "success") loadPhotos(); });
    }
</script>
</body>
</html>
