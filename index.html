<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentin & Marilou | Album</title>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff85a1; --bg: #fff5f7; --text: #4a4a4a; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        
        #lock-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 300px; }
        
        #main-content { display: none; }
        header { text-align: center; padding: 30px 20px; background: white; }
        h1 { font-family: 'Dancing Script', cursive; font-size: 3rem; color: var(--primary); margin: 0; }

        /* Navigation par ancres */
        .anchor-nav { 
            position: sticky; top: 0; background: white; padding: 10px; 
            display: flex; gap: 10px; overflow-x: auto; white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100; border-bottom: 1px solid #eee;
        }
        .anchor-link { 
            background: var(--bg); color: var(--primary); padding: 6px 15px; 
            border-radius: 20px; text-decoration: none; font-size: 0.85rem; font-weight: 600; 
        }

        .event-section { padding: 20px; }
        .event-title { font-family: 'Dancing Script', cursive; color: var(--primary); font-size: 2rem; margin: 20px 0 10px 0; border-bottom: 2px solid #ffe0e6; display: inline-block; }

        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .photo-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .photo-item.selected { border-color: var(--primary); opacity: 0.7; transform: scale(0.9); }

        /* Contrôles */
        .top-controls { padding: 10px 20px; display: flex; justify-content: flex-end; }
        .select-btn { background: none; border: 1.5px solid var(--primary); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 600; cursor: pointer; }

        #multi-del-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ff4757; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-weight: 600; box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4); display: none; z-index: 600; }
        #upload-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 30px; box-shadow: 0 5px 15px rgba(255,133,161,0.4); z-index: 500; }

        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 10000; align-items: center; justify-content: center; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        input { padding: 12px; border: 2px solid #eee; border-radius: 10px; margin: 10px 0; width: 90%; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="login-box">
            <h2 style="font-family: 'Dancing Script'; color: var(--primary);">Coucou !</h2>
            <input type="password" id="pass-input" placeholder="Mot de passe...">
            <button class="btn" onclick="checkPassword()">Ouvrir l'album</button>
        </div>
    </div>

    <div id="main-content">
        <header><h1>Valentin & Marilou</h1></header>
        
        <div class="anchor-nav" id="anchor-nav"></div>

        <div class="top-controls">
            <button class="select-btn" id="select-toggle" onclick="toggleSelectionMode()">Sélectionner</button>
        </div>

        <div id="full-gallery"></div>

        <button id="upload-btn" onclick="startUpload()">+</button>
        <button id="multi-del-btn" onclick="deleteSelected()">Supprimer (0)</button>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="">
    </div>

    <script>
        const CONFIG = {
            CLOUD_NAME: "ditbsvebr",
            UPLOAD_PRESET: "souvenirs_preset",
            API_KEY: "274456693674898",
            API_SECRET: "68eaHGHtTmP1_4SN8bjpM4QU90p8",
            TAG_ROOT: "souvenirs_valentin_marilou",
            PASSWORD: "19.Juin.2025"
        };

        let allPhotos = [];
        let groupedPhotos = {};
        let selectedIds = new Set();
        let isSelectMode = false;

        if (localStorage.getItem('isLogged') === 'true') unlock();

        function checkPassword() {
            if (document.getElementById('pass-input').value === CONFIG.PASSWORD) {
                localStorage.setItem('isLogged', 'true'); unlock();
            } else alert("Oups ! ❤️");
        }

        function unlock() {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            loadPhotos();
        }

        async function loadPhotos() {
            const url = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/list/${CONFIG.TAG_ROOT}.json?v=${new Date().getTime()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                allPhotos = data.resources;
                
                groupedPhotos = {};
                allPhotos.forEach(img => {
                    const event = img.context?.custom?.caption || "Nos Souvenirs";
                    if (!groupedPhotos[event]) groupedPhotos[event] = [];
                    groupedPhotos[event].push(img);
                });

                renderNavigation();
                renderGallery();
            } catch (err) { console.log("Prêt pour les photos !"); }
        }

        function renderNavigation() {
            const nav = document.getElementById('anchor-nav');
            const events = Object.keys(groupedPhotos).sort();
            nav.innerHTML = events.map(e => `<a href="#${e.replace(/\s+/g, '-')}" class="anchor-link">${e}</a>`).join('');
        }

        function renderGallery() {
            const container = document.getElementById('full-gallery');
            const events = Object.keys(groupedPhotos).sort();
            
            container.innerHTML = events.map(event => `
                <div class="event-section" id="${event.replace(/\s+/g, '-')}">
                    <div class="event-title">${event}</div>
                    <div class="photo-grid">
                        ${groupedPhotos[event].map(img => `
                            <img class="photo-item ${selectedIds.has(img.public_id) ? 'selected' : ''}" 
                                 src="https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/w_300,c_fill,g_auto/${img.public_id}.${img.format}" 
                                 onclick="handlePhotoClick('${img.public_id}', '${img.format}')">
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function handlePhotoClick(publicId, format) {
            if (isSelectMode) {
                if (selectedIds.has(publicId)) selectedIds.delete(publicId);
                else selectedIds.add(publicId);
                updateUI();
                renderGallery();
            } else {
                const img = document.getElementById('lightbox-img');
                img.src = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/q_auto,f_auto/${publicId}.${format}`;
                document.getElementById('lightbox').style.display = 'flex';
            }
        }

        function toggleSelectionMode() {
            isSelectMode = !isSelectMode;
            if (!isSelectMode) selectedIds.clear();
            document.getElementById('select-toggle').innerText = isSelectMode ? "Annuler" : "Sélectionner";
            updateUI();
            renderGallery();
        }

        function updateUI() {
            const delBtn = document.getElementById('multi-del-btn');
            delBtn.style.display = selectedIds.size > 0 ? 'block' : 'none';
            delBtn.innerText = `Supprimer (${selectedIds.size})`;
        }

        async function deleteSelected() {
            if (!confirm(`Supprimer ces ${selectedIds.size} photos ?`)) return;
            for (const id of selectedIds) {
                const ts = Math.round(new Date().getTime() / 1000);
                const sig = CryptoJS.SHA1(`public_id=${id}&timestamp=${ts}${CONFIG.API_SECRET}`).toString();
                const fd = new FormData();
                fd.append("public_id", id); fd.append("timestamp", ts);
                fd.append("api_key", CONFIG.API_KEY); fd.append("signature", sig);
                await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUD_NAME}/image/destroy`, { method: "POST", body: fd });
            }
            location.reload();
        }

        function startUpload() {
            const name = prompt("Nom de l'événement ?", "Sortie");
            if (!name) return;
            cloudinary.openUploadWidget({
                cloudName: CONFIG.CLOUD_NAME, uploadPreset: CONFIG.UPLOAD_PRESET,
                tags: [CONFIG.TAG_ROOT], context: { custom: { caption: name.trim() } },
                sources: ['local', 'camera'], multiple: true, language: "fr"
            }, (error, result) => { if (!error && result.event === "success") loadPhotos(); });
        }

        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }
    </script>
</body>
</html>
