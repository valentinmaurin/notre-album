<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentin & Marilou | Album</title>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff85a1; --bg: #fff5f7; --text: #4a4a4a; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; scroll-behavior: smooth; }
        #lock-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 320px; }
        #main-content { display: none; }
        header { text-align: center; padding: 30px 20px; background: white; border-bottom: 1px solid #ffe0e6; }
        h1 { font-family: 'Dancing Script', cursive; font-size: 2.8rem; color: var(--primary); margin: 0; }
        .nav-wrapper { position: sticky; top: 0; background: white; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .anchor-nav { display: flex; gap: 10px; overflow-x: auto; padding: 12px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .anchor-link { background: var(--bg); color: var(--primary); padding: 8px 18px; border-radius: 20px; text-decoration: none; font-size: 0.8rem; font-weight: 600; border: 1px solid #ffe0e6; }
        .section-title { font-family: 'Dancing Script', cursive; color: var(--primary); font-size: 2.2rem; margin: 30px 20px 15px 20px; padding-bottom: 5px; border-bottom: 2px solid #ffe0e6; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; padding: 0 20px; }
        .photo-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: 0.2s; box-sizing: border-box; }
        .photo-item.selected { border-color: var(--primary); opacity: 0.6; transform: scale(0.9); }
        .select-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; }
        #upload-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 30px; box-shadow: 0 5px 15px rgba(255,133,161,0.4); z-index: 500; }
        #multi-del-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ff4757; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-weight: 600; box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4); display: none; z-index: 600; }
        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 10000; align-items: center; justify-content: center; }
        #lightbox img { max-width: 100%; max-height: 90%; object-fit: contain; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 20px 15px; font-size: 30px; cursor: pointer; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 15px; }
        input { padding: 12px; border: 2px solid #eee; border-radius: 10px; width: 90%; outline: none; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="login-box">
        <h2 style="font-family: 'Dancing Script'; color: var(--primary); font-size: 2.2rem;">Notre Album</h2>
        <input type="password" id="pass-input" placeholder="Mot de passe...">
        <button class="btn" onclick="checkPassword()">Ouvrir</button>
    </div>
</div>

<div id="main-content">
    <header><h1>Valentin & Marilou</h1></header>
    <div class="nav-wrapper"><div class="anchor-nav" id="anchor-nav"></div></div>
    <div class="select-bar">
        <span id="photo-count" style="font-size: 0.8rem; opacity: 0.6;">Chargement...</span>
        <button style="background:none; border:1px solid var(--primary); color:var(--primary); border-radius:15px; padding:4px 12px; font-size:0.75rem;" onclick="toggleSelectMode()" id="toggle-btn">Sélectionner</button>
    </div>
    <div id="full-gallery"></div>
    <button id="upload-btn" onclick="startUpload()">+</button>
    <button id="multi-del-btn" onclick="deleteSelected()">Supprimer (0)</button>
</div>

<div id="lightbox">
    <button style="position:absolute;top:20px;right:20px;color:white;background:none;border:none;font-size:40px;z-index:10001;" onclick="closeLightbox()">×</button>
    <button class="lightbox-nav" style="left:0;" onclick="changePhoto(-1)">‹</button>
    <img id="lightbox-img" src="">
    <button class="lightbox-nav" style="right:0;" onclick="changePhoto(1)">›</button>
</div>

<script>
    const CONFIG = {
        CLOUD_NAME: "ditbsvebr",
        UPLOAD_PRESET: "souvenirs_preset",
        API_KEY: "274456693674898",
        API_SECRET: "68eaHGHtTmP1_4SN8bjpM4QU90p8",
        TAG_ROOT: "souvenirs_valentin_marilou",
        PASSWORD: "19.Juin.2025"
    };

    let allPhotos = [];
    let selectedIds = new Set();
    let isSelectMode = false;
    let currentPhotoIndex = 0;

    if (localStorage.getItem('isLogged') === 'true') unlock();

    function checkPassword() {
        if (document.getElementById('pass-input').value === CONFIG.PASSWORD) {
            localStorage.setItem('isLogged', 'true'); unlock();
        } else alert("Mot de passe incorrect ❤️");
    }

    function unlock() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadPhotos();
    }

    async function loadPhotos() {
        const url = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/list/${CONFIG.TAG_ROOT}.json?v=${new Date().getTime()}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            allPhotos = data.resources;
            
            const grouped = {};
            allPhotos.forEach(img => {
                let event = "Nos Souvenirs";
                if (img.context?.custom?.caption && img.context.custom.caption !== "[object Object]") {
                    event = img.context.custom.caption;
                }
                if (!grouped[event]) grouped[event] = [];
                grouped[event].push(img);
            });

            document.getElementById('photo-count').innerText = `${allPhotos.length} souvenirs partagés`;
            renderNav(grouped);
            renderGallery(grouped);
        } catch (err) { console.error("Erreur de chargement"); }
    }

    function renderNav(grouped) {
        const nav = document.getElementById('anchor-nav');
        nav.innerHTML = Object.keys(grouped).sort().map(e => `<a href="#${e.replace(/\s+/g, '-')}" class="anchor-link">${e}</a>`).join('');
    }

    function renderGallery(grouped) {
        const container = document.getElementById('full-gallery');
        container.innerHTML = Object.keys(grouped).sort().map(event => `
            <div id="${event.replace(/\s+/g, '-')}">
                <div class="section-title">${event}</div>
                <div class="photo-grid">
                    ${grouped[event].map(img => `
                        <img class="photo-item ${selectedIds.has(img.public_id) ? 'selected' : ''}" 
                             src="https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/w_400,c_fill,g_auto/${img.public_id}.${img.format}" 
                             onclick="handlePhotoClick('${img.public_id}')">
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function handlePhotoClick(pid) {
        if (isSelectMode) {
            if (selectedIds.has(pid)) selectedIds.delete(pid);
            else selectedIds.add(pid);
            updateUI();
        } else {
            currentPhotoIndex = allPhotos.findIndex(p => p.public_id === pid);
            updateLightboxImage();
            document.getElementById('lightbox').style.display = 'flex';
        }
    }

    function changePhoto(dir) {
        currentPhotoIndex += dir;
        if (currentPhotoIndex < 0) currentPhotoIndex = allPhotos.length - 1;
        if (currentPhotoIndex >= allPhotos.length) currentPhotoIndex = 0;
        updateLightboxImage();
    }

    function updateLightboxImage() {
        const img = allPhotos[currentPhotoIndex];
        document.getElementById('lightbox-img').src = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/q_auto,f_auto/${img.public_id}.${img.format}`;
    }

    function toggleSelectMode() {
        isSelectMode = !isSelectMode;
        if (!isSelectMode) selectedIds.clear();
        document.getElementById('toggle-btn').innerText = isSelectMode ? "Annuler" : "Sélectionner";
        updateUI();
    }

    function updateUI() {
        document.querySelectorAll('.photo-item').forEach(el => {
            const pid = el.onclick.toString().match(/'(.*?)'/)[1];
            el.classList.toggle('selected', selectedIds.has(pid));
        });
        const delBtn = document.getElementById('multi-del-btn');
        delBtn.style.display = selectedIds.size > 0 ? 'block' : 'none';
        delBtn.innerText = `Supprimer (${selectedIds.size})`;
    }

    async function deleteSelected() {
        if (!confirm(`Effacer définitivement ces ${selectedIds.size} souvenirs ?`)) return;
        
        const btn = document.getElementById('multi-del-btn');
        btn.disabled = true;
        btn.innerText = "Suppression en cours...";

        for (const id of selectedIds) {
            const ts = Math.round(new Date().getTime() / 1000);
            const signatureString = `public_id=${id}&timestamp=${ts}${CONFIG.API_SECRET}`;
            const sig = CryptoJS.SHA1(signatureString).toString();
            
            const fd = new FormData();
            fd.append("public_id", id);
            fd.append("timestamp", ts);
            fd.append("api_key", CONFIG.API_KEY);
            fd.append("signature", sig);

            try {
                await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUD_NAME}/image/destroy`, { method: "POST", body: fd });
            } catch (err) { console.error("Erreur de suppression pour", id); }
        }
        
        alert("Les souvenirs sélectionnés ont été retirés !");
        location.reload();
    }

    function startUpload() {
        const name = prompt("Nom de l'événement ?", "Nos Souvenirs");
        if (!name) return;
        cloudinary.openUploadWidget({
            cloudName: CONFIG.CLOUD_NAME, uploadPreset: CONFIG.UPLOAD_PRESET,
            tags: [CONFIG.TAG_ROOT], context: { caption: name.trim() },
            sources: ['local', 'camera'], multiple: true, language: "fr"
        }, (error, result) => { if (!error && result.event === "success") loadPhotos(); });
    }

    function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }
</script>
</body>
</html>
