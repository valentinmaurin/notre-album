<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentin & Marilou | Album</title>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff85a1; --bg: #fff5f7; --text: #4a4a4a; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }

        /* Verrouillage */
        #lock-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        /* Contenu */
        #main-content { display: none; padding: 20px; }
        header { text-align: center; padding: 20px 0; }
        h1 { font-family: 'Dancing Script', cursive; font-size: 3rem; color: var(--primary); margin: 0; }

        /* Dossiers */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 30px; }
        .folder { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; position: relative; }
        .folder:hover { transform: scale(1.05); }
        .folder-icon { font-size: 50px; display: block; margin-bottom: 10px; }
        .folder-name { font-weight: 600; font-size: 0.9rem; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Galerie (dans dossier) */
        #gallery-view { display: none; }
        .back-btn { background: none; border: none; color: var(--primary); font-weight: 600; cursor: pointer; margin-bottom: 20px; font-size: 1rem; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .photo-item { width: 100%; height: 140px; object-fit: cover; border-radius: 10px; cursor: pointer; }

        /* Lightbox (Agrandir photo) */
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; }
        #lightbox img { max-width: 95%; max-height: 90%; border-radius: 5px; }

        /* Bouton + */
        #upload-btn { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 35px; cursor: pointer; box-shadow: 0 5px 20px rgba(255,133,161,0.5); }
        
        input { padding: 12px; border: 2px solid #eee; border-radius: 10px; margin: 10px 0; outline: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="login-box">
            <h2 style="font-family: 'Dancing Script'; color: var(--primary);">Notre Album Secret</h2>
            <input type="password" id="pass-input" placeholder="Mot de passe...">
            <br>
            <button class="btn" onclick="checkPassword()">Ouvrir</button>
        </div>
    </div>

    <div id="main-content">
        <header><h1>Valentin & Marilou</h1></header>

        <div id="folder-view">
            <h3 style="text-align:center">Nos √âv√©nements</h3>
            <div class="folder-grid" id="folder-container"></div>
        </div>

        <div id="gallery-view">
            <button class="back-btn" onclick="showFolders()">‚Üê Retour aux dossiers</button>
            <h2 id="current-folder-title" style="color: var(--primary)"></h2>
            <div class="photo-grid" id="photo-container"></div>
        </div>

        <button id="upload-btn">+</button>
    </div>

    <div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>

    <script>
        const CONFIG = {
            CLOUD_NAME: "ditbsvebr",
            UPLOAD_PRESET: "souvenirs_preset",
            TAG_NAME: "souvenirs_valentin_marilou",
            PASSWORD: "19.Juin.2025" // <--- CHANGE LE MOT DE PASSE ICI
        };

        let allMemories = {};

        // 1. GESTION SESSION (RESTE CONNECT√â)
        if (localStorage.getItem('isLogged') === 'true') {
            unlock();
        }

        function checkPassword() {
            if (document.getElementById('pass-input').value === CONFIG.PASSWORD) {
                localStorage.setItem('isLogged', 'true');
                unlock();
            } else { alert("Mot de passe incorrect ‚ù§Ô∏è"); }
        }

        function unlock() {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            loadPhotos();
        }

        // 2. CHARGEMENT ET TRI PAR DOSSIER
        async function loadPhotos() {
            const url = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/list/${CONFIG.TAG_NAME}.json?timestamp=${new Date().getTime()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // On groupe les photos par leur "caption" (Nom de l'√©v√©nement)
                allMemories = {};
                data.resources.forEach(img => {
                    const folderName = img.context?.custom?.caption || "Sans titre";
                    if (!allMemories[folderName]) allMemories[folderName] = [];
                    allMemories[folderName].push(img);
                });
                renderFolders();
            } catch (err) { console.log("Aucune photo pour le moment."); }
        }

        function renderFolders() {
            const container = document.getElementById('folder-container');
            container.innerHTML = Object.keys(allMemories).map(name => `
                <div class="folder" onclick="showGallery('${name}')">
                    <span class="folder-icon">üìÇ</span>
                    <span class="folder-name">${name}</span>
                    <small>${allMemories[name].length} photo(s)</small>
                </div>
            `).join('');
        }

        function showGallery(folderName) {
            document.getElementById('folder-view').style.display = 'none';
            document.getElementById('gallery-view').style.display = 'block';
            document.getElementById('current-folder-title').innerText = folderName;
            
            const container = document.getElementById('photo-container');
            container.innerHTML = allMemories[folderName].map(img => `
                <img class="photo-item" src="https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/w_400,c_fill/${img.public_id}.${img.format}" onclick="zoom('${img.public_id}.${img.format}')">
            `).join('');
        }

        function showFolders() {
            document.getElementById('folder-view').style.display = 'block';
            document.getElementById('gallery-view').style.display = 'none';
        }

        function zoom(publicId) {
            document.getElementById('lightbox-img').src = `https://res.cloudinary.com/${CONFIG.CLOUD_NAME}/image/upload/q_auto/${publicId}`;
            document.getElementById('lightbox').style.display = 'flex';
        }

        // 3. AJOUT DE SOUVENIRS AVEC NOM D'√âV√âNEMENT
        document.getElementById('upload-btn').onclick = () => {
            const eventName = prompt("Quel est le nom de l'√©v√©nement ? (ex: Sortie au Parc)", "Mon Souvenir");
            if (!eventName) return;

            const myWidget = cloudinary.createUploadWidget({
                cloudName: CONFIG.CLOUD_NAME,
                uploadPreset: CONFIG.UPLOAD_PRESET,
                tags: [CONFIG.TAG_NAME],
                context: { custom: { caption: eventName } },
                sources: ['local', 'camera'],
                clientAllowedFormats: ["png","jpg","jpeg","heic"],
                multiple: true, // Tu peux envoyer plusieurs photos d'un coup !
                styles: { palette: { window: "#FFFFFF", sourceBg: "#FFF5F7", windowBorder: "#FF85A1", tabIcon: "#FF85A1", action: "#FF85A1", textDark: "#4A4A4A" } }
            }, (error, result) => {
                if (!error && result && result.event === "success") {
                    loadPhotos(); // Recharge les donn√©es sans rafra√Æchir la page !
                }
            });
            myWidget.open();
        };
    </script>
</body>
</html>
